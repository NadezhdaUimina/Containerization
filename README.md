# Containerization



## Урок 1. Механизм пространства имен


механизмов два - namespaces и cgroups, и все остальные инструменты (Docker, LXC (Canonical) и так далее) основываются на них.

### Файловая система

*Абсолютно все объекты в ОС Linux - файлы. Делятся они лишь на типы:*

● Обычные файлы - символьные и двоичные файлы.

● Каталоги (директории) - список ссылок на файлы либо на другие каталоги.

● Символьные ссылки - ссылки на другие файлы и каталоги по имени. 

● Блочные устройства - интерфейсы, предназначенные для взаимодействия с аппаратной составляющей. 

● Сокеты и каналы - интерфейсы для взаимодействия с программной составляющей ОС.


*root - является корнем ФС*


*Другие директории в ОС:*

● /bin –  исполняемые файлы самых необходимых утилит. Эта папка может быть символьной ссылкой на /usr/bin.

● /boot – файлы, которые необходимы для первичного этапа загрузки ОС Linux: загрузки ядра и его компоненты.

● /dev –  блочные и символьные файлы устройств (диски, терминалы, клавиатуры, принтеры и так далее).

● /etc – хнабор конфигурационных файлов системы и прикладных программ.

● /home – домашние каталоги пользователей для хранения «личных» файлов.

● /lib – файлы библиотек, необходимых для работы утилит, системного и прикладного ПО, может быть символьной ссылкой на /usr/bin.

● /mnt – каталог, для подключения файловых систем (съемных носителей и др.).

● /opt – каталог для различного рода дополнительных программ (проприетарных драйверов, агентов мониторинга и др.).

● /proc – одна из важнейших директорий, содержащая в себе сущности-ссылки на файлы, содержащиеся в оперативной памяти, в которых содержится информация о выполняемых в системе процессах.

● /root – домашний каталог пользователя root. 

● /sbin – набор файлов системных утилит, необходимых для загрузки ядра ОС, резервного копирования и восстановления системы. Также может быть символьной ссылкой на /usr/sbin.

● /sys – виртуальная файловая система sysfs, содержит информацию об аппаратном обеспечении (ЦПУ, ОЗУ, дисках, сетевых устройствах), драйверах, ядре системы и др.

● /tmp – каталог для различного рода временных файлов, обычно зачищается при каждой загрузке системы.

● /usr – каталог с исполняемыми и конфигурационными файлами.

● /var – содержит файлы, создаваемые или используемые различными программами (логи, очереди, идентификаторы процессов, базы данных и тд.).


        chroot - изменение корневого каталога сист. для запущенного процесса и всех его дочерних процессов

        Пример:

        chrroot  «имя папки»  /bin/bash - перенос данных из /bin/bash в предварительно созданную директорию.
        
        cp  /bin/bash  «имя папки»/bin – копируем данные (так же копируем все зависимости создав для них необходимые директории ldd  /bin/bash – просмотр зависимостей)
        
### Механизм пространства имен
  
Пространство имен (namespaces) - это абстракция в системе Linux, в которой находятся системные ресурсы. Тип ресурса зависит от типа пространства имен. namespace - это сущность изначально предоставляется самим ядром ОС Linux и является необходимым компонентом, принимающим участие в процедуре запуска любого процесса в системе. В любой момент времени любой процесс может принадлежать только одному пространству имен каждого типа. Также namespace - это механизм, обеспечивающий изоляцию процессов друг от друга в UNIX-системах. 

*Типы namespace:*

PID - изоляция идентификатора процессов

Network - сетевая изоляция (сеть, порты, стеки и так далее)

User - изоляция пользователей и групп

Mount - переопределение точек монтирования

IPC (Inter Process Communication) - изоляция межпроцессного взаимодействия (в т.ч. очереди POSIX)

UTS (UNIX Time-Sharing) - изоляция имени хоста и доменного имени



## Урок 2. Механизмы контрольных групп


*cgroup* — это механизм для иерархической организации процессов и распределения системных ресурсов

*LXC* - подсистема позволяет запускать несколько изолированных друг от друга экземпляров ОС Linux на одном узле. Данная система не использует технологию виртуализации, то есть не создает виртуальных машин. Система создает виртуальное окружение с собственным пространством процессов и сетевым стеком.

*Возможности LXC:*

● Ограничение ресурсов

● Приоритизация (выделение различного количества ресурсов для различных приложений)

● Регистрация затрат тех или иных ресурсов приложением либо группой приложений

● Изоляция

● Управление

*Механизм состоит из двух главных частей: ядра (cgroup core) и подсистем.*

*Список подсистем зависит от версии ядра. Основные компоненты следующие:*

● blkio (block I/O) - это подсистема управления процедурами ввода/вывода блочных устройств. Для ограничения доступа приложению или процессу записываются значения в псевдофайлы. Подсистема содержит огромное количество параметров.
   - blkio.weight - позволяет определить относительный вес (в значениях от 100 до 1000) ввода-вывода контрольной группы. Чем больше значение, тем больше ресурсов получит приложение или процесс. Например 100 приложение получит возможность производить 100 операций чтения/записи в секунду. Пример определения параметра в псевдофайл:
               echo 200 > blkio.weight
   - blkio.weight_device - определяет относительный вес для конкретного устройства, которое доступно в файловой системе. Этот параметр позволяет переопределить общее значение blkio.weight. Переопределение: 
               echo 8:0 200 > blkio.weight_device
Вывод такой в связи с тем, что устройство /dev/sda соответствует в списке
устройств номеру 8:0. Проверить это можно с помощью команды lsblk:
Как можно видеть, значения, вводимые нами, совпадают со значениями,
выводимыми системой.

● cpuacct — формирует отчеты об использовании ресурсов процессора.

● cpu — предоставляет доступ процессам в рамках контрольной группы к ресурсам процессорной подсистемы.

● cpuset — распределяет задачи в рамках контрольной группы между имеющимися процессорными ядрами.

● devices — предоставляет доступ или же, наоборот, блокирует доступ к устройствам.

● freezer — приостанавливает и возобновляет выполнение задач в рамках контрольной группы.

● memory — занимается выделением памяти для групп процессов.

● net_cls — помечает сетевые пакеты специальным тэгом, который в дальнейшем позволяет идентифицировать пакеты, порождаемые определённой задачей в рамках контрольной группы.

● netprio — используется для динамической установки приоритетов по трафику.

● ns - используется для группировки процессов в отдельное пространство имен, где процессы могут взаимодействовать между собой и при этом будут изолированы от внешних процессов.

● pids — используется для ограничения количества процессов в рамках контрольной группы.

● unified — автоматически монтирует файловую систему в каталог /sys/fs/cgroup/unified при запуске системы.

*Помимо специализированных файлов, каждая директория содержит в себе набор управляющих файлов:* 

● cgroup.clone_children — позволяет передавать дочерним контрольным группам свойства родительских.

● tasks — содержит список PID всех процессов, включённых в контрольные группы.

● cgroup.procs — содержит список TGID (Thread Group Id) групп процессов, включённых в контрольные группы.

● cgroup.event_control — позволяет отправлять уведомления в случае изменения статуса контрольной группы.

● release_agent — содержится команда, которая будет выполнена, если включена опция notify_on_release. Может использоваться, например, для автоматического удаления пустых контрольных групп.

● notify_on_release — содержит булеву переменную (0 или 1), включающую (или, наоборот, отключающую), выполнение команду, указанной в release_agent.

*Псевдофайл* - файл, который не представляет из себя файл в базовой файловой системе на диске. Это файлы, которые автоматически создаются для представления какого-либо другого объекта в виде файла с целью возможности взаимодействия с ним. Простой пример /dev/sda.
